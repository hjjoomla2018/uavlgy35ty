/**
 * @package DJ-Reviews
 * @copyright Copyright (C) DJ-Extensions.com, All rights reserved.
 * @license http://www.gnu.org/licenses GNU/GPL
 * @author url: http://dj-extensions.com
 * @author email contact@dj-extensions.com
 *
 * DJ-Reviews is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * DJ-Reviews is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with DJ-Reviews. If not, see <http://www.gnu.org/licenses/>.
 *
 */

!function(t,i){var e=function(t){this.init(t)};e.prototype={constructor:e,init:function(i){var e=this;this.options=i,this.url=i.url,this.current_page=0,this.formId="djrv_review_form-"+this.options.object_id,this.formAnchorId="djrv-your-review-"+this.options.object_id,this.listId="djrv-reviews-list-"+this.options.object_id,this.ratingId="djrv-rating-full-"+this.options.object_id,this.ratingAvgId="djrv-rating-avg-"+this.options.object_id,this.addButtonClass="djrv_add_button",this.editButtonClass="djrv_edit_button",this.deleteButtonClass="djrv_delete_button",this.closeButtonClass="djrv_close_form_button";var n=t('[data-toggle="djreviewsform"][data-objectid="'+this.options.object_id+'"]');if(n.length>0){if(n.unbind("click"),t("#"+this.formAnchorId).length<1){var o=t("<div />",{id:"djrv-your-review-"+this.options.object_id,class:"djrv_review_form djreviews djrv_clearfix",html:""});t(document.body).append(o),e.loadEditForm(0,!1,!1)}n.click(function(i){var n=t(this);i.preventDefault();var o="";if(n.attr("data-customparams")){var r=JSON.parse(n.attr("data-customparams")),s=[];for(var a in r)s.push("custom["+a+"]="+r[a]);o=s.join("&")}e.loadEditForm(0,!0,!1,o)})}this.attachControls(),this.refreshAll(!0,!1)},attachControls:function(){var i=this;if(this.reviewForm=t("#"+this.formId),this.formAnchor=t("#"+this.formAnchorId),this.reviewsList=t("#"+this.listId),this.rating=t("#"+this.ratingId),this.ratingAvg=t("#"+this.ratingAvgId),this.addReviewButtons=t.find("."+this.addButtonClass),this.editReviewButtons=t.find("."+this.editButtonClass),this.deleteReviewButtons=t.find("."+this.deleteButtonClass),this.closeReviewButtons=t.find("."+this.closeButtonClass),this.paginationLinks=t("#"+this.listId).find(".djrv_pagination a.pagenav"),this.paginationLinks.length>0&&t(this.paginationLinks).each(function(e,n){t(n).unbind("click"),t(n).click(function(e){e.preventDefault();var o=t(n).attr("data-page");o&&(i.tweenOut(i.reviewsList),i.getReviews(o,!0,!0))})}),this.deleteReviewButtons.length>0&&t(this.deleteReviewButtons).each(function(e,n){t(n).unbind("click"),t(n).click(function(e){t(i.formAnchor).hide(),i.tweenOut(i.reviewsList),i.tweenOut(i.rating),i.tweenOut(i.ratingAvg),e.preventDefault(),t.ajax({type:"GET",async:!0,url:t(n).attr("href"),data:"format=raw&ts="+Date.now()}).done(function(e){t(i.reviewsList).trigger("djrv:reviewDeleted"),i.getReviews(i.current_page,!0,!1),i.getRating(!1),i.getRatingAvg(!1)})})}),this.addReviewButtons.length>0&&this.formAnchor.length>0&&t(this.addReviewButtons).each(function(e,n){t(n).unbind("click"),t(n).click(function(e){e.preventDefault(),t(i.formAnchor).hide(),i.loadEditForm(0,!0,!1)})}),this.closeReviewButtons.length>0&&this.formAnchor.length>0&&t(this.closeReviewButtons).each(function(e,n){t(n).unbind("click"),t(n).click(function(e){e.preventDefault(),t(i.formAnchor).hide(),i.reviewsList.length>0&&t("html, body").animate({scrollTop:t(i.reviewsList).offset().top},20)})}),t("#"+i.formAnchorId+" .djrv_modal-backdrop").unbind("click"),t("#"+i.formAnchorId+" .djrv_modal-backdrop").click(function(e){e.preventDefault(),t(i.formAnchor).hide(),i.reviewsList.length>0&&t("html, body").animate({scrollTop:t(i.reviewsList).offset().top},20)}),this.editReviewButtons.length>0&&this.formAnchor.length>0&&t(this.editReviewButtons).each(function(e,n){t(n).unbind("click"),t(n).click(function(e){e.preventDefault(),t(i.formAnchor).hide(),i.tweenOut(i.reviewsList),i.tweenOut(i.rating),i.tweenOut(i.ratingAvg),i.loadEditForm(t(n).attr("data-id"),!0,!1)})}),this.reviewForm.submit(function(e){e.preventDefault();var n=i.reviewForm.serialize();n+="&format=json&ts="+Date.now(),i.tweenOut(i.reviewsList),i.tweenOut(i.reviewForm),i.tweenOut(i.rating),i.tweenOut(i.ratingAvg),t.ajax({type:"POST",async:!1,url:i.url,data:n}).done(function(e){var n,o=!1;try{n=jQuery.parseJSON(e)}catch(t){n={status:0},o=!0,i.showAlert(e)}1!=n.status||o?o?(t(i.formAnchor).hide(),i.refreshAll(!1,!0)):(i.showAlert(n.error_message),i.tweenIn(i.reviewsList),i.tweenIn(i.reviewForm),i.tweenIn(i.rating),i.tweenIn(i.ratingAvg)):(""!=n.message&&i.showAlert(n.message),t(i.formAnchor).find("form").empty(),setTimeout(function(){t(i.formAnchor).hide(),t(i.formAnchor).trigger("djrv:reviewSaved"),i.refreshAll(!0,!0)},1500))}).fail(function(t,i,e){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})}),this.reviewForm.length>0){var e=t('[data-wrapper="djrv-avg-'+this.options.object_id+'"]');e.length>0&&e.find(".djrv_star").unbind("click").click(function(e){e.preventDefault(),t(i.formAnchor).hide(),i.loadEditForm(0,!0,!1)}).css("cursor","pointer")}},loadEditForm:function(i,e,n,o){var r=this,s=r.options.captcha_key;s=s?"&captcha="+s:"";var a=void 0===o?"":"&"+o,d="option=com_djreviews&view=reviewform&format=raw&id="+parseInt(i)+s+a+"&ts="+Date.now();0==i&&(d+="&object_id="+r.options.object_id),t.ajax({type:"GET",async:n,url:r.url,data:d,dataType:"html"}).done(function(i){try{document.formvalidator=new JFormValidator}catch(t){}if(t(r.formAnchor).replaceWith(i),r.addToolTips(),r.attachControls(),s&&r.initRecaptcha(),void 0!=typeof JFormValidator)try{t(r.formAnchor).find("button.validate").click(function(i){if(i.stopPropagation(),document.formvalidator.isValid(t("#"+r.formId)))return!0;var e=t("#system-message-container");return e.length>0?(t("#djrv_msg-"+r.options.object_id).html(e.html()),e.html(" ")):r.showAlert(r.options.lang.invalid_form),!1})}catch(t){}e&&(t(r.formAnchor).show(),t("#"+r.formAnchorId+" .djrv_modal-backdrop").addClass("in"),t("#"+r.formAnchorId+" .djrv_modal").addClass("in"),r.addToolTips(),t("html, body").animate({scrollTop:t(r.formAnchor).offset().top},200),r.tweenIn(r.reviewsList),r.tweenIn(r.rating),r.tweenIn(r.ratingAvg))}).fail(function(t,i,e){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getReviews:function(i,e,n){var o=this;void 0!=i&&i||(i=0),o.current_page=i;var r="option=com_djreviews&view=reviewslist&format=raw&id="+o.options.object_id+"&limitstart="+i+"&ts="+Date.now();t.ajax({type:"GET",async:e,url:o.url,data:r}).done(function(i){t(o.reviewsList).replaceWith(i),o.addToolTips(),o.attachControls(),o.tweenIn(o.reviewsList),n&&t("html, body").animate({scrollTop:t(o.reviewsList).offset().top},20)}).fail(function(t,i,e){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getRating:function(i){var e=this,n="option=com_djreviews&view=rating&format=raw&id="+e.options.object_id+"&ts="+Date.now();t.ajax({type:"GET",async:i,url:e.url,data:n}).done(function(i){t(e.rating).replaceWith(i),e.addToolTips(),e.tweenIn(e.rating)}).fail(function(t,i,e){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})},getRatingAvg:function(i){var e=this;if(0!=e.ratingAvg.length){var n="option=com_djreviews&view=rating&layout=avg&format=raw&id="+e.options.object_id+"&ts="+Date.now();t.ajax({type:"GET",async:i,url:e.url,data:n}).done(function(i){t(e.ratingAvg).replaceWith(i),e.addToolTips(),e.tweenIn(e.ratingAvg)}).fail(function(t,i,e){return 403!=t.status&&(401!=t.status&&(400!=t.status&&void 0))})}},refreshAll:function(t,i){this.getRating(t),this.getRatingAvg(t),this.getReviews(0,t,i),this.loadEditForm(0,!1,!0)},tweenIn:function(i){t(i).length>0&&t(i).css({opacity:"1"})},tweenOut:function(i){t(i).length>0&&t(i).css({opacity:"0.3"})},addToolTips:function(){t(".djrv_tooltip").popover({html:!0,trigger:"hover focus",container:"body"})},showAlert:function(i){var e='<div class="alert">'+i+"</div>";t("#djrv_msg-"+this.options.object_id).html(e)},initRecaptcha:function(){var t,i=document.getElementById("djrv_captcha-"+this.options.object_id);i&&""===i.innerHTML&&(t=i.dataset?i.dataset:{sitekey:i.getAttribute("data-sitekey"),theme:i.getAttribute("data-theme"),size:i.getAttribute("data-size")},grecaptcha.render(i,t))}},window.DJReviewsCore=e}(jQuery);